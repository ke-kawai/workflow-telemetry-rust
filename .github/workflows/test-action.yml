name: Test Workflow Telemetry

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  test-telemetry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Start telemetry monitoring
        run: |
          chmod +x ./telemetry
          TELEMETRY_INTERVAL=2 TELEMETRY_ITERATIONS=50 ./telemetry > /tmp/telemetry.log 2>&1 &
          echo $! > /tmp/telemetry.pid
          echo "Telemetry started (PID: $(cat /tmp/telemetry.pid))"
      
      - name: Simulate workload
        run: |
          echo "Running CPU-intensive task..."
          for i in {1..5}; do
            echo "Task $i"
            dd if=/dev/zero of=/dev/null count=100000 bs=1024 2>/dev/null &
            sleep 2
            killall dd 2>/dev/null || true
          done
          echo "Workload complete"
          sleep 5
      
      - name: Stop telemetry and generate report
        if: always()
        run: |
          if [ -f /tmp/telemetry.pid ]; then
            PID=$(cat /tmp/telemetry.pid)
            echo "Checking telemetry process (PID: $PID)..."
            ps -p $PID -o pid,stat,comm || echo "Process not found"
            
            echo "Stopping telemetry (PID: $PID)..."
            kill -TERM $PID 2>/dev/null || true
            
            echo "Waiting for process to finish..."
            for i in {1..10}; do
              if ps -p $PID > /dev/null 2>&1; then
                echo "Process still running after ${i}s..."
                sleep 1
              else
                echo "Process exited after ${i}s"
                break
              fi
            done
            
            echo "=== Telemetry Log ==="
            cat /tmp/telemetry.log || true
            echo "=== End Log ==="
            
            # Check if summary was written
            if [ -n "$GITHUB_STEP_SUMMARY" ] && [ -f "$GITHUB_STEP_SUMMARY" ]; then
              echo "=== Step Summary Content ==="
              cat "$GITHUB_STEP_SUMMARY" || true
              echo "=== End Summary ==="
            else
              echo "⚠️ GITHUB_STEP_SUMMARY not found or not set"
            fi
          fi
