name: Test Workflow Telemetry

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  test-telemetry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Start telemetry monitoring
        run: |
          chmod +x ./telemetry
          TELEMETRY_INTERVAL=2 TELEMETRY_ITERATIONS=15 ./telemetry > /tmp/telemetry.log 2>&1 &
          echo $! > /tmp/telemetry.pid
          echo "Telemetry started (PID: $(cat /tmp/telemetry.pid))"
      
      - name: Simulate workload
        run: |
          echo "Running CPU-intensive task..."
          for i in {1..5}; do
            echo "Task $i"
            dd if=/dev/zero of=/dev/null count=100000 bs=1024 2>/dev/null &
            sleep 2
            killall dd 2>/dev/null || true
          done
          echo "Workload complete"
      
      - name: Wait for telemetry to complete naturally
        run: |
          if [ -f /tmp/telemetry.pid ]; then
            PID=$(cat /tmp/telemetry.pid)
            echo "Waiting for telemetry (PID: $PID) to complete naturally..."
            
            for i in {1..120}; do
              if ps -p $PID > /dev/null 2>&1; then
                if [ $((i % 10)) -eq 0 ]; then
                  echo "Still running after ${i}s..."
                fi
                sleep 1
              else
                echo "Process completed after ${i}s"
                break
              fi
            done
            
            echo "=== Telemetry Log ==="
            cat /tmp/telemetry.log || true
            echo "=== End Log ==="
          fi
      
      - name: Generate SVG Charts
        if: always()
        run: |
          if [ -f /tmp/telemetry_data.json ]; then
            ./telemetry --generate-svg /tmp/telemetry_data.json
            
            # SVGã‚’PNGã«å¤‰æ›
            sudo apt-get update -qq
            sudo apt-get install -y -qq librsvg2-bin
            
            if [ -f cpu-usage.svg ]; then
              rsvg-convert -w 800 -h 400 cpu-usage.svg -o cpu-usage.png
              echo "âœ… CPU PNG created"
            fi
            
            if [ -f memory-usage.svg ]; then
              rsvg-convert -w 800 -h 400 memory-usage.svg -o memory-usage.png
              echo "âœ… Memory PNG created"
            fi
          fi
      
      - name: Upload Charts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-charts
          path: |
            cpu-usage.png
            memory-usage.png
          retention-days: 90
      
      - name: Display Summary
        if: always()
        run: |
          if [ -f /tmp/telemetry_data.json ]; then
            echo "# Workflow Telemetry Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # JSONã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’å–å¾—
            DATA_POINTS=$(jq '.cpu | length' /tmp/telemetry_data.json)
            
            echo "## Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Data Points Collected**: $DATA_POINTS" >> $GITHUB_STEP_SUMMARY
            echo "- **Monitoring Interval**: 2 seconds" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Duration**: $((DATA_POINTS * 2)) seconds" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # CPUçµ±è¨ˆ
            AVG_CPU=$(jq '[.cpu[].total_load] | add / length' /tmp/telemetry_data.json)
            MAX_CPU=$(jq '[.cpu[].total_load] | max' /tmp/telemetry_data.json)
            
            echo "## CPU Usage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Average**: ${AVG_CPU}%" >> $GITHUB_STEP_SUMMARY
            echo "- **Peak**: ${MAX_CPU}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # ãƒ¡ãƒ¢ãƒªçµ±è¨ˆ
            AVG_MEM=$(jq '[.memory[].used_mb] | add / length' /tmp/telemetry_data.json)
            MAX_MEM=$(jq '[.memory[].used_mb] | max' /tmp/telemetry_data.json)
            
            echo "## Memory Usage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Average**: ${AVG_MEM} MB" >> $GITHUB_STEP_SUMMARY
            echo "- **Peak**: ${MAX_MEM} MB" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## Charts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š Download charts from the **Artifacts** section above" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No telemetry data available" >> $GITHUB_STEP_SUMMARY
          fi
