# Rust版 GitHub Actions Workflow Telemetry - 要件定義書

## 1. プロジェクト概要

### 1.1 目的
既存の `workflow-telemetry-action` をRustで完全に再実装し、セキュリティ・透明性・パフォーマンスを向上させた安全な GitHub Actions ワークフローモニタリングツールを開発する。

### 1.2 背景と課題
現行の `catchpoint/workflow-telemetry-action` には以下の問題がある：

#### セキュリティ・透明性の問題
1. **バイナリブラックボックス問題**
   - `proc_tracer_ubuntu-20` / `proc_tracer_ubuntu-22` のソースコードが非公開
   - ELF バイナリ（1.2MB～1.6MB）の内部挙動を検証不可能
   - プロセス情報収集時に不正なデータ取得が行われる可能性を排除できない

2. **外部API依存の問題**
   - グラフ生成に `https://api.globadge.com/v1/chartgen/` を使用
   - ワークフローのメトリクスデータ（CPU/メモリ/ネットワーク/ディスクI/O）を外部サービスへ送信
   - 403エラー発生時にも大量のデータがログに露出
   - データプライバシーとコンプライアンスのリスク

3. **データ漏洩リスク**
   - プロセス引数やファイルパスに機密情報（API KEY、内部パス等）が含まれる可能性
   - 外部API経由でこれらが第三者に送信されるリスク

### 1.3 解決アプローチ
Rustによる完全な自己完結型実装により：
- **透明性**：全コードをオープンソース化、バイナリもビルド可能
- **セキュリティ**：外部API呼び出しゼロ、データは全てローカル処理
- **パフォーマンス**：ネイティブバイナリによる高速実行
- **信頼性**：強力な型システムとメモリ安全性

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 Stat Collector（統計コレクター）
**目的**: システムリソースメトリクスを定期収集しグラフ化

**収集メトリクス**:
1. **CPU使用率**
   - ユーザーモードCPU使用率（%）
   - システムモードCPU使用率（%）
   
2. **メモリ使用量**
   - 使用中メモリ（MB）
   - 利用可能メモリ（MB）
   
3. **ネットワークI/O**
   - 受信量（MB）
   - 送信量（MB）
   
4. **ディスクI/O**
   - 読み込み量（MB）
   - 書き込み量（MB）
   
5. **ディスク使用量**
   - 使用中ディスク容量（MB）
   - 利用可能ディスク容量（MB）

**実装要件**:
- Linuxの `/proc` ファイルシステムから直接読み取り
  - `/proc/stat` - CPU統計
  - `/proc/meminfo` - メモリ情報
  - `/proc/net/dev` - ネットワーク統計
  - `/proc/diskstats` - ディスクI/O統計
  - `/proc/mounts` + `statvfs` - ディスク容量
- 収集間隔: デフォルト5秒（設定可能）
- データ構造: `Vec<Metric>` で時系列データを保持
- **グラフ生成**: SVG形式でローカル生成（外部API不使用）
  - Rust SVGライブラリ（`plotters`）を使用
  - Base64エンコードしてMarkdownに埋め込み

## 3. 実装優先順位

### Phase 1: MVP (最小機能製品)
- [x] CPU メトリクス収集
- [x] SVG グラフ生成 (折れ線グラフ)
- [x] Markdown レポート生成
- [x] GitHub Job Summary 出力

### Phase 2: コア機能完成
- [ ] Memory メトリクス収集
- [ ] Network I/O メトリクス
- [ ] Disk I/O メトリクス
- [ ] Step Tracer (Mermaid Gantt)
- [ ] PR コメント投稿機能

### Phase 3: プロセストレース
- [ ] eBPF プログラム開発
- [ ] Rust-eBPF 統合
- [ ] プロセスイベントパーサー
- [ ] Gantt チャート生成

### Phase 4: セキュリティ強化
- [ ] 機密情報マスキング
- [ ] 入力検証強化
- [ ] セキュリティ監査

## 4. 技術スタック

### 4.1 Rust Crates (依存ライブラリ)

| Crate | 用途 |
|-------|------|
| `anyhow` | エラーハンドリング |
| `serde`, `serde_json` | JSON シリアライズ |
| `plotters` | グラフ生成 (SVG) |
| `base64` | Base64エンコード |
| `chrono` | 日時処理 |

## 5. 現在の実装状況

**Phase 1 MVP 完了**:
- 総行数: 478行
- バイナリサイズ: 846KB
- テスト: 6個
- 依存クレート: 5個

**実装済み**:
- CPU収集 (`/proc/stat`)
- SVG生成 (`plotters`)
- Markdown生成
- GitHub Summary出力
